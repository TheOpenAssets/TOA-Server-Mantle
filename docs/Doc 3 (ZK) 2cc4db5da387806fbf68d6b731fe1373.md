# Doc 3 : (ZK)

Created by: Divyraj Saini
Category: Proposal
Last edited by: Abhinav Pangaria
Reviewers: Abhinav Pangaria, Kaushal Chaudhari
Stage: Approved
Text: Have a look and review the flow

```mermaid
sequenceDiagram
    participant Supplier
    participant Platform
    participant PlatformWallet
    participant MongoDB
    participant Mantle
    participant Investor
    participant YieldVault
    participant LendingPool

    Note over Supplier: Step 1: Asset Onboarding
    
    Supplier->>Platform: Upload invoice ($50k, 90 days)
    Platform->>Platform: Verify: KYC, ZK proof, attestation
    Platform->>Mantle: Mint RWA tokens (1000 tokens)
    Mantle->>PlatformWallet: Mint to PLATFORM wallet<br/>(NOT supplier wallet)
    
    Platform->>MongoDB: Record supplier position:<br/>{<br/>  supplier: 0xABC,<br/>  assetId: "INV001",<br/>  tokensOwned: 1000,<br/>  custodialStatus: "PLATFORM_HELD",<br/>  claimable: true<br/>}
    
    Platform->>Supplier: Show portfolio:<br/>"You own 1000 tokens (value $50k)<br/>Status: Listed for sale<br/>Custody: Platform"

    Note over Platform,Investor: Step 2: Primary Marketplace Sale
    
    Platform->>Platform: List on primary market:<br/>Price: $45 per token (10% discount)
    
    Investor->>Platform: Buy 400 tokens for $18k
    Platform->>PlatformWallet: Transfer 400 tokens to investor
    
    Platform->>MongoDB: Update positions:<br/>Supplier: 600 tokens (60% remaining)<br/>Investor: 400 tokens (40% ownership)
    
    Platform->>Supplier: Notification:<br/>"400 tokens sold for $18k<br/>Remaining: 600 tokens ($30k value)<br/>Funds transferred to your wallet"
    
    Platform->>Supplier: Transfer $18k USDC
    
    Note over Supplier: Step 3A: Claim Tokens (Optional)
    
    Supplier->>Platform: "Claim my 600 tokens to wallet"
    Platform->>PlatformWallet: Transfer 600 tokens:<br/>From: PlatformWallet<br/>To: Supplier wallet (0xABC)
    
    Platform->>MongoDB: Update:<br/>{<br/>  custodialStatus: "SELF_CUSTODIED",<br/>  claimable: false<br/>}
    
    Platform->>Supplier: "600 tokens now in your wallet"

    Note over Supplier: Step 3B: Collateralize for Lending
    
    Supplier->>Platform: "Use 600 tokens as collateral"
    Platform->>PlatformWallet: Lock 600 tokens in escrow
    
    Platform->>LendingPool: Calculate LTV:<br/>Collateral: $30k tokens<br/>Max borrow: $21k (70% LTV)
    
    LendingPool->>Platform: Approve $20k loan at 8% APR
    Platform->>Supplier: Transfer $20k USDC loan
    
    Platform->>MongoDB: Record loan:<br/>{<br/>  borrower: 0xABC,<br/>  collateral: 600 tokens (assetId: INV001),<br/>  loanAmount: $20k,<br/>  interestRate: 8% APR,<br/>  dueDate: invoice maturity,<br/>  autoRepay: true<br/>}

    Note over Mantle,Supplier: Step 4: Invoice Matures & Settlement
    
    Note over Platform: Buyer pays $50k invoice
    
    Platform->>YieldVault: Distribute yield:<br/>Total: $50k<br/>Per token: $50 (from $45 purchase)
    
    YieldVault->>YieldVault: Calculate distributions:<br/>Investor (400 tokens): $20k principal + $2k yield<br/>Supplier (600 tokens): $30k value + $3k yield
    
    YieldVault->>MongoDB: Check: Does supplier have loan?
    MongoDB->>YieldVault: Yes:<br/>Loan: $20k<br/>Interest due: $1.6k (8% for 90 days)<br/>Total due: $21.6k
    
    YieldVault->>YieldVault: Auto-repayment calculation:<br/>Supplier yield: $3k<br/>Loan + interest: $21.6k<br/>Shortfall: $18.6k

    alt Yield Covers Full Repayment
        YieldVault->>LendingPool: Repay $21.6k from yield
        YieldVault->>Supplier: Send remaining $11.4k
        Platform->>Supplier: Notification:<br/>"Loan auto-repaid from yield<br/>Remaining: $11.4k profit"
    else Yield Insufficient (This Case)
        YieldVault->>LendingPool: Partial repay $3k from yield
        YieldVault->>Supplier: Request $18.6k payment
        
        Supplier->>LendingPool: Pay remaining $18.6k
        LendingPool->>PlatformWallet: Unlock 600 tokens
        
        Platform->>Supplier: Notification:<br/>"Paid $18.6k to close loan<br/>Net position: Received $18k initially,<br/>Yield $3k, Paid $18.6k back<br/>Net profit: $2.4k"
    end
    
    YieldVault->>Investor: Distribute $22k<br/>(principal $20k + yield $2k)

    Note over Platform: Step 5: Portfolio State Updates
    
    Platform->>MongoDB: Update final positions:<br/>Supplier:<br/>  - Initial: 1000 tokens<br/>  - Sold: 400 tokens → $18k<br/>  - Yield on 600: $3k<br/>  - Loan cost: $1.6k<br/>  - Net profit: $2.4k<br/><br/>Investor:<br/>  - Purchased: 400 tokens → $18k<br/>  - Yield received: $2k<br/>  - ROI: 11% in 90 days
    
    Platform->>Supplier: Portfolio update:<br/>"Asset INV001 settled<br/>Status: COMPLETED<br/>Total earnings: $2.4k"

```

@Abhinav Pangaria Have a look this seems good to me.

@Abhinav Pangaria Audit looks like

```mermaid
sequenceDiagram
    participant Auditor
    participant VerifierUI
    participant Backend
    participant MongoDB
    participant Mantle
    participant ZKVerifier
    participant EigenDA

    Note over Auditor: Scenario 1: Investor Due Diligence
    
    Auditor->>VerifierUI: Check asset "INV001"
    VerifierUI->>Backend: GET /audit/asset/INV001
    
    Backend->>MongoDB: Query asset metadata
    MongoDB->>Backend: Return:<br/>- Asset exists<br/>- Face value: $50k<br/>- Due date: 90 days<br/>- Risk tier: A<br/>- ZK proof hash<br/>- Attestation hash
    
    Backend->>Mantle: Read on-chain commitment
    Mantle->>Backend: Return:<br/>- Token supply: 1000<br/>- Holders: 2<br/>- Registry status: REGISTERED<br/>- Not revoked
    
    Backend->>ZKVerifier: Verify proof validity
    ZKVerifier->>Backend: Proof valid ✓
    
    Backend->>EigenDA: Fetch blob by anchorPointer
    EigenDA->>Backend: Return Merkle bundle
    Backend->>Backend: Verify: keccak256(blob) == on-chain hash
    
    Backend->>VerifierUI: Display:<br/>✓ Asset verified by platform<br/>✓ Supplier KYC'd (wallet 0xABC...)<br/>✓ Buyer KYC'd (wallet 0xDEF...)<br/>✓ Invoice amount: $50k<br/>✓ ZK proof valid<br/>✓ Data integrity confirmed<br/>⚠️ Supplier/buyer names: ENCRYPTED
    
    Note over Auditor: Can verify EVERYTHING except identities

    Note over Auditor: Scenario 2: Regulatory Audit (Deep Inspection)
    
    Auditor->>Backend: Request identity disclosure<br/>(with court order)
    
    Backend->>Backend: Verify legal authorization
    Backend->>Backend: Initiate threshold decryption<br/>(3-of-5 multisig)
    
    Note over Backend: Keys held by:<br/>1. Platform legal<br/>2. External auditor<br/>3. Regulator<br/>4. User (supplier)<br/>5. Independent trustee
    
    Backend->>MongoDB: Retrieve encrypted blobs:<br/>- Supplier DigiLocker doc<br/>- Buyer DigiLocker doc<br/>- Invoice details
    
    Backend->>Backend: Decrypt with threshold keys
    
    Backend->>Backend: Log immutably:<br/>{<br/>  accessedBy: "Auditor XYZ",<br/>  reason: "Regulatory investigation",<br/>  authorization: "Court Order #123",<br/>  timestamp: now,<br/>  assetId: "INV001",<br/>  dataAccessed: ["supplier_identity", "buyer_identity"]<br/>}
    
    Backend->>Mantle: Commit access log hash on-chain<br/>(immutable record of who accessed when)
    
    Backend->>Auditor: Return decrypted data:<br/>- Supplier: Tech Supplies Ltd<br/>- Buyer: Acme Manufacturing<br/>- Full invoice details
    
    Note over Auditor: Scenario 3: Platform Self-Audit
    
    Auditor->>Backend: Run reconciliation check
    
    Backend->>MongoDB: Query all assets
    Backend->>Mantle: Query all on-chain commitments
    
    Backend->>Backend: Compare:<br/>- MongoDB asset count vs on-chain tokens<br/>- MongoDB hashes vs on-chain hashes<br/>- MongoDB balances vs on-chain balances
    
    alt Mismatch Found
        Backend->>Backend: Flag inconsistency:<br/>"Asset INV001:<br/>MongoDB shows 1000 tokens<br/>Mantle shows 900 tokens<br/>SYNC ERROR"
        
        Backend->>Auditor: Alert: Data integrity issue
    else All Match
        Backend->>Auditor: ✓ Full reconciliation passed<br/>All assets synced correctly
    end

```

@Abhinav Pangaria zk proofing 

```mermaid
sequenceDiagram
    participant Supplier
    participant Platform
    participant ZKProver
    participant Mantle
    participant Investors
    participant Buyer

    Note over Supplier: Has verified wallet (DigiLocker)
    Note over Buyer: Has verified wallet (DigiLocker)
    
    Supplier->>Platform: Upload invoice PDF
    Platform->>Platform: Extract: amount, due date, parties
    
    Platform->>ZKProver: Generate proof:<br/>Private: supplier name, buyer name, invoice details<br/>Public: amount, due date, risk tier, wallet hashes
    
    ZKProver->>Platform: Return proof:<br/>"$50k invoice, 90 days, A-tier risk"<br/>(No names revealed)
    
    Platform->>Mantle: Register invoice:<br/>tokenize(assetId, $50k, dueDate, proofHash)
    Mantle->>Mantle: Mint RWA tokens
    
    Investors->>Mantle: Browse available invoices
    Note over Investors: See: amount, due date, risk<br/>Don't see: supplier/buyer names
    
    Investors->>Mantle: Fund invoice (pay 90% = $45k)
    Mantle->>Supplier: Release $45k early payment
    
    Note over Buyer: Invoice due date arrives
    
    Buyer->>Platform: Pay $50k to settlement account
    
    Platform->>ZKProver: Generate settlement proof:<br/>Private: bank transfer details<br/>Public: "$50k received, on time"
    
    ZKProver->>Platform: Return proof
    Platform->>Mantle: Record settlement(assetId, proofHash)
    
    Mantle->>Mantle: Distribute yield:<br/>Investors get $50k - $45k = $5k profit
    Mantle->>Investors: Release payment + yield
```